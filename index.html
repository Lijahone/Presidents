<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Presidents ‚Äî Kid Friendly</title>
  <meta name="theme-color" content="#6b7cff">
  <style>
    :root{
      --bg1:#0c1026;
      --bg2:#121a3a;
      --card:#171f44;
      --ink:#f3f6ff;
      --muted:#b9c4ff;
      --accent:#6b7cff;
      --accent2:#53d18a;
      --danger:#ff6b6b;
      --shadow: 0 14px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(107,124,255,.25), transparent 60%),
        radial-gradient(800px 500px at 90% 20%, rgba(83,209,138,.18), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    /* --- Layout --- */
    .wrap{max-width: 980px; margin:0 auto; padding:18px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap;
      padding:10px 12px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, rgba(107,124,255,.95), rgba(83,209,138,.80));
      display:grid; place-items:center;
      box-shadow: 0 12px 24px rgba(0,0,0,.25);
      font-weight: 1000;
      letter-spacing: .3px;
    }
    h1{font-size:18px; margin:0}
    .sub{font-size:12px; color:var(--muted)}

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .pill b{color:var(--ink)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    /* --- Screens --- */
    .screen{display:none; margin-top:14px;}
    .screen.active{display:block;}

    /* --- Panels / Cards --- */
    .panel{
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .panel h2{font-size:14px; margin:0 0 10px; color:#dbe2ff}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width: 820px){ .grid2{grid-template-columns: 1fr;} }

    label{font-size:12px; color:var(--muted)}
    input[type="text"], input[type="number"], select{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--ink);
      outline:none;
      font-size: 16px;
    }
    input[type="number"]{width: 120px;}

    .btn{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(107,124,255,.18);
      color: var(--ink);
      padding: 14px 16px;
      font-weight: 900;
      letter-spacing: .2px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 18px rgba(0,0,0,.20);
      font-size: 16px;
      min-height: 52px;
    }
    .btn:hover{filter: brightness(1.05);}
    .btn:disabled{opacity:.45; cursor:not-allowed;}
    .btn.secondary{background: rgba(255,255,255,.07);}
    .btn.ok{background: rgba(83,209,138,.16); border-color: rgba(83,209,138,.35);}
    .btn.danger{background: rgba(255,107,107,.18); border-color: rgba(255,107,107,.35);}
    .btn.big{font-size:18px; padding:18px 18px; min-height: 62px;}
    .btn.full{width:100%;}

    .menu{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 700px){ .menu{grid-template-columns: 1fr;} }

    .toggle{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }
    .toggle b{font-size:13px}
    .toggle span{display:block; font-size:12px; color:var(--muted); margin-top:2px}
    .toggle input{transform: scale(1.25);}

    .playersList{display:grid; gap:10px; margin-top:10px;}
    .playerChip{
      display:flex; justify-content:space-between; gap:12px; align-items:center;
      padding:12px 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .playerChip.active{outline: 3px solid rgba(107,124,255,.55); background: rgba(107,124,255,.12);}
    .playerChip .name{font-weight: 1000; font-size: 15px;}
    .playerChip .meta{font-size: 12px; color: var(--muted); margin-top:2px}

    /* --- Game Table --- */
    .table{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .pileBox{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
    }
    .pileBig{
      font-size: 18px;
      font-weight: 1000;
      letter-spacing: .2px;
    }
    .pileSmall{font-size:12px; color:var(--muted);}
    .kidHint{
      font-size: 13px;
      color: #dbe2ff;
      line-height: 1.35;
    }

    .handWrap{
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .hand{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      min-height: 84px;
      padding-top: 4px;
    }
    .cardBtn{
      width: 84px;
      height: 120px;
      border-radius: 16px;
      border: 2px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.10));
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding: 10px;
      user-select:none;
      position: relative;
      transform: translateZ(0);
    }
    .cardBtn .r{
      font-size: 28px;
      font-weight: 1000;
      letter-spacing: .2px;
      line-height: 1;
    }
    .cardBtn .s{
      font-size: 22px;
      opacity: .95;
      line-height: 1;
    }
    .cardBtn.red{color: #ffb1b6;}
    .cardBtn.sel{
      outline: 4px solid rgba(107,124,255,.70);
      background: linear-gradient(180deg, rgba(107,124,255,.22), rgba(0,0,0,.10));
    }
    .cardBtn:active{transform: scale(.985);}
    @media (max-width: 520px){
      .cardBtn{ width: 76px; height: 112px; }
      .cardBtn .r{ font-size: 26px; }
    }

    .actionBar{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 700px){ .actionBar{grid-template-columns: 1fr;} }

    .countPill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .countPill b{color:var(--ink)}

    /* --- Overlay / pass device --- */
    .overlay{
      position: fixed; inset: 0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.74);
      z-index: 50;
      padding: 16px;
    }
    .overlay.active{display:flex;}
    .modal{
      width: 100%;
      max-width: 540px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.14));
      padding: 16px;
      box-shadow: var(--shadow);
      text-align:center;
    }
    .modal h3{margin:6px 0 8px; font-size: 16px;}
    .modal .big{font-size: 28px; font-weight: 1000; margin: 6px 0;}
    .modal .muted{color:var(--muted); font-size: 13px; line-height: 1.35;}
    .hr{height:1px; background: rgba(255,255,255,.10); margin: 12px 0;}
    .modal .btn{width:100%;}

    /* Small footer log */
    details{margin-top:10px;}
    summary{cursor:pointer; color:var(--muted); font-size: 12px;}
    .log{
      margin-top:8px;
      max-height: 220px;
      overflow:auto;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }
    .log b{color: var(--ink);}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">P</div>
        <div>
          <h1>Presidents</h1>
          <div class="sub">Kid-friendly ‚Ä¢ rule toggles ‚Ä¢ (online multiplayer later)</div>
        </div>
      </div>
      <div class="row">
        <span class="pill">Screen: <b id="screenPill">Home</b></span>
        <span class="pill">Round: <b id="roundPill">‚Äî</b></span>
      </div>
    </div>

    <!-- HOME -->
    <div class="screen active" id="screenHome">
      <div class="panel">
        <h2>Welcome</h2>
        <div class="kidHint">Tap <b>Play Game</b> to start. You can adjust rules any time before the round begins.</div>
        <div class="menu">
          <button class="btn big ok full" id="btnGoPlay">‚ñ∂ Play Game</button>
          <button class="btn big secondary full" id="btnGoRules">‚öôÔ∏è Rules</button>
        </div>
      </div>
    </div>

    <!-- RULES -->
    <div class="screen" id="screenRules">
      <div class="panel">
        <h2>Rules</h2>

        <div class="grid2">
          <div class="panel">
            <h2>Game Settings</h2>
            <div class="row" style="justify-content:space-between;">
              <div>
                <label>Players (3‚Äì8)</label>
                <input type="number" id="playerCount" min="3" max="8" value="4" />
              </div>
              <div style="flex:1">
                <label>Preset</label>
                <select id="preset">
                  <option value="classic">Classic</option>
                  <option value="fast">Fast (2 clears + 4 clears)</option>
                  <option value="noswaps">No swaps</option>
                </select>
              </div>
            </div>

            <div style="margin-top:12px;">
              <label>Player names</label>
              <div class="playersList" id="playerInputs"></div>
            </div>
          </div>

          <div class="panel">
            <h2>Toggle Rules</h2>

            <div class="toggle">
              <div>
                <b>2 clears the pile</b>
                <span>Playing a 2 wipes the pile + you play again</span>
              </div>
              <input type="checkbox" id="r_twoClears" checked />
            </div>

            <div class="toggle" style="margin-top:10px;">
              <div>
                <b>4-of-a-kind clears (single play)</b>
                <span>Playing 4 of the same rank clears the pile</span>
              </div>
              <input type="checkbox" id="r_fourClears" />
            </div>

            <div class="toggle" style="margin-top:10px;">
              <div>
                <b>Must match set size</b>
                <span>If a pair is played, you must play a pair</span>
              </div>
              <input type="checkbox" id="r_matchSize" checked />
            </div>

            <div class="toggle" style="margin-top:10px;">
              <div>
                <b>Lowest card starts</b>
                <span>Player holding the lowest card starts the round</span>
              </div>
              <input type="checkbox" id="r_lowestStarts" checked />
            </div>

            <div class="toggle" style="margin-top:10px;">
              <div>
                <b>Swaps between rounds</b>
                <span>President ‚Üî Scum (2), Vice ‚Üî Vice Scum (1)</span>
              </div>
              <input type="checkbox" id="r_swaps" checked />
            </div>

            <div class="row" style="margin-top:12px;">
              <span class="pill">Ranking: <b>3 ‚Ä¶ A, 2 high</b></span>
              <span class="pill">Suits: <b>ignored</b></span>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px; justify-content:space-between;">
          <button class="btn secondary" id="btnBackHome1">‚Üê Home</button>
          <button class="btn ok" id="btnStartGame">Start Game</button>
        </div>
      </div>
    </div>

    <!-- GAME -->
    <div class="screen" id="screenGame">
      <div class="panel">
        <h2>Game</h2>

        <div class="table">
          <div class="panel pileBox">
            <div>
              <div class="pileBig" id="pileTop">Pile: (empty)</div>
              <div class="pileSmall" id="pileReq">Required set size: ‚Äî</div>
              <div class="pileSmall" id="pilePass">Passes: ‚Äî</div>
            </div>
            <div class="row">
              <span class="countPill">Turn: <b id="currentName">‚Äî</b></span>
              <span class="countPill">Selected: <b id="selInfo">0</b></span>
            </div>
          </div>

          <div class="handWrap">
            <div class="kidHint" id="turnHint">‚Äî</div>
            <div class="row" style="margin-top:10px;">
              <button class="btn secondary" id="btnReveal">Reveal</button>
              <button class="btn secondary" id="btnHide">Hide</button>
            </div>

            <div class="hand" id="hand"></div>

            <div class="actionBar">
              <button class="btn ok big" id="btnPlay" disabled>Play</button>
              <button class="btn big" id="btnPass" disabled>Pass</button>
              <button class="btn secondary big" id="btnClearSel" disabled>Clear</button>
            </div>

            <div class="row" style="margin-top:12px; justify-content:space-between;">
              <button class="btn secondary" id="btnExitToHome">‚Üê Home</button>
              <button class="btn secondary" id="btnNextRound" disabled>Next Round</button>
            </div>

            <details>
              <summary>Show log (optional)</summary>
              <div class="log" id="log"></div>
            </details>
          </div>

          <div class="panel">
            <h2>Players</h2>
            <div class="playersList" id="playersPanel"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- PASS DEVICE / RESULTS -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h3 id="ovTitle">Next player</h3>
      <div class="big" id="ovBig">‚Äî</div>
      <div class="muted" id="ovMuted">‚Äî</div>
      <div class="hr"></div>
      <button class="btn ok big" id="ovOk">Continue</button>
    </div>
  </div>

<script>
(() => {
  // -------------------- Helpers --------------------
  const $ = (id) => document.getElementById(id);

  const SUITS = ["C","D","H","S"];
  const SUIT_SYMBOL = { C:"‚ô£", D:"‚ô¶", H:"‚ô•", S:"‚ô†" };
  const SUIT_COLOR_CLASS = { C:"", D:"red", H:"red", S:"" };

  const rankToLabel = (r) => {
    if (r <= 10) return String(r);
    if (r === 11) return "J";
    if (r === 12) return "Q";
    if (r === 13) return "K";
    if (r === 14) return "A";
    if (r === 15) return "2";
    return "?";
  };

  const sortHand = (hand) => {
    hand.sort((a,b) => (a.rank - b.rank) || (SUITS.indexOf(a.suit) - SUITS.indexOf(b.suit)));
  };

  const cardToKey = (c) => c.rank + "_" + c.suit;

  // -------------------- State --------------------
  const state = {
    screen: "home", // home | rules | game
    phase: "setup", // setup | in_round | between_rounds
    rules: {
      twoClearsPile: true,
      fourOfAKindClears: false,
      mustMatchSetSize: true,
      lowestCardStarts: true,
      swapsEnabled: true,
    },
    players: [], // {name, hand: [], out, finishIndex}
    roundNumber: 1,
    turnIndex: 0,
    leaderIndex: 0,

    pileTop: null, // {rank,count,playerIndex}
    requiredCount: null,
    passes: new Set(),
    lastNonPassIndex: null,

    handRevealed: false,
    selected: new Set(), // indices in hand
    finishOrder: [],

    log: [],
  };

  // -------------------- DOM --------------------
  const screenPill = $("screenPill");
  const roundPill = $("roundPill");

  const screenHome = $("screenHome");
  const screenRules = $("screenRules");
  const screenGame = $("screenGame");

  const btnGoPlay = $("btnGoPlay");
  const btnGoRules = $("btnGoRules");
  const btnBackHome1 = $("btnBackHome1");

  const playerCount = $("playerCount");
  const playerInputs = $("playerInputs");
  const preset = $("preset");

  const r_twoClears = $("r_twoClears");
  const r_fourClears = $("r_fourClears");
  const r_matchSize = $("r_matchSize");
  const r_lowestStarts = $("r_lowestStarts");
  const r_swaps = $("r_swaps");

  const btnStartGame = $("btnStartGame");

  const pileTopEl = $("pileTop");
  const pileReqEl = $("pileReq");
  const pilePassEl = $("pilePass");

  const currentName = $("currentName");
  const selInfo = $("selInfo");
  const turnHint = $("turnHint");
  const handEl = $("hand");

  const btnReveal = $("btnReveal");
  const btnHide = $("btnHide");
  const btnPlay = $("btnPlay");
  const btnPass = $("btnPass");
  const btnClearSel = $("btnClearSel");
  const btnNextRound = $("btnNextRound");
  const btnExitToHome = $("btnExitToHome");

  const playersPanel = $("playersPanel");
  const logEl = $("log");

  const overlay = $("overlay");
  const ovTitle = $("ovTitle");
  const ovBig = $("ovBig");
  const ovMuted = $("ovMuted");
  const ovOk = $("ovOk");

  // -------------------- UI Utils --------------------
  function setScreen(name){
    state.screen = name;
    screenPill.textContent = name[0].toUpperCase() + name.slice(1);
    screenHome.classList.toggle("active", name === "home");
    screenRules.classList.toggle("active", name === "rules");
    screenGame.classList.toggle("active", name === "game");
  }

  function addLog(msg, strong=false){
    const line = strong ? `<b>${msg}</b>` : msg;
    state.log.unshift(line);
    if (state.log.length > 80) state.log.pop();
    renderLog();
  }

  function renderLog(){
    logEl.innerHTML = state.log.map(x => `<div style="margin-bottom:8px;">${x}</div>`).join("");
  }

  function clampInt(v, min, max) {
    let x = parseInt(v, 10);
    if (Number.isNaN(x)) x = min;
    return Math.max(min, Math.min(max, x));
  }

  function defaultName(i) {
    const defs = ["Player 1","Player 2","Player 3","Player 4","Player 5","Player 6","Player 7","Player 8"];
    return defs[i] || `Player ${i+1}`;
  }

  function renderPlayerInputs(){
    const n = clampInt(playerCount.value, 3, 8);
    playerCount.value = n;
    playerInputs.innerHTML = "";
    for (let i=0; i<n; i++) {
      const inp = document.createElement("input");
      inp.type = "text";
      inp.placeholder = `Player ${i+1} name`;
      inp.value = defaultName(i);
      inp.id = `pname_${i}`;
      playerInputs.appendChild(inp);
    }
  }

  function syncRulesFromUI(){
    state.rules.twoClearsPile = !!r_twoClears.checked;
    state.rules.fourOfAKindClears = !!r_fourClears.checked;
    state.rules.mustMatchSetSize = !!r_matchSize.checked;
    state.rules.lowestCardStarts = !!r_lowestStarts.checked;
    state.rules.swapsEnabled = !!r_swaps.checked;
  }

  function applyPreset(name){
    if (name === "classic") {
      r_twoClears.checked = true;
      r_fourClears.checked = false;
      r_matchSize.checked = true;
      r_lowestStarts.checked = true;
      r_swaps.checked = true;
    } else if (name === "fast") {
      r_twoClears.checked = true;
      r_fourClears.checked = true;
      r_matchSize.checked = true;
      r_lowestStarts.checked = true;
      r_swaps.checked = true;
    } else if (name === "noswaps") {
      r_twoClears.checked = true;
      r_fourClears.checked = false;
      r_matchSize.checked = true;
      r_lowestStarts.checked = true;
      r_swaps.checked = false;
    }
    syncRulesFromUI();
  }

  // -------------------- Game Logic --------------------
  function makeDeck(){
    const deck = [];
    for (let rank = 3; rank <= 15; rank++) {
      for (const suit of SUITS) deck.push({ rank, suit });
    }
    for (let i = deck.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [deck[i], deck[j]] = [deck[j], deck[i]];
    }
    return deck;
  }

  function deal(deck, n){
    const hands = Array.from({length:n}, () => []);
    let idx=0;
    while (deck.length) {
      hands[idx % n].push(deck.pop());
      idx++;
    }
    hands.forEach(sortHand);
    return hands;
  }

  function activePlayerIndices(){
    const arr=[];
    for (let i=0;i<state.players.length;i++) if (!state.players[i].out) arr.push(i);
    return arr;
  }

  function nextActiveIndex(fromIndex){
    const n = state.players.length;
    for (let step=1; step<=n; step++){
      const idx = (fromIndex + step) % n;
      if (!state.players[idx].out) return idx;
    }
    return fromIndex;
  }

  function countActiveNotPassed(){
    const act = activePlayerIndices();
    let notPassed=0;
    for (const i of act) if (!state.passes.has(i)) notPassed++;
    return notPassed;
  }

  function findLowestCardHolder(){
    let best=null;
    for (let pi=0; pi<state.players.length; pi++){
      for (const c of state.players[pi].hand){
        if (!best) best = {pi, c};
        else{
          const a=c, b=best.c;
          const suitA=SUITS.indexOf(a.suit), suitB=SUITS.indexOf(b.suit);
          if (a.rank < b.rank || (a.rank===b.rank && suitA < suitB)) best = {pi, c};
        }
      }
    }
    return best ? best.pi : 0;
  }

  function validateSelection(cards){
    if (state.phase !== "in_round") return {ok:false, reason:"Not in round."};
    if (!state.handRevealed) return {ok:false, reason:"Tap Reveal first."};
    if (!cards.length) return {ok:false, reason:"Pick at least 1 card."};

    const rank = cards[0].rank;
    for (const c of cards) if (c.rank !== rank) return {ok:false, reason:"Cards must match."};

    const count = cards.length;

    if (state.requiredCount !== null && state.rules.mustMatchSetSize) {
      if (count !== state.requiredCount) return {ok:false, reason:`Must play ${state.requiredCount} card(s).`};
    }

    if (state.pileTop) {
      const topRank = state.pileTop.rank;
      const isTwoClear = state.rules.twoClearsPile && rank === 15;
      const isFourClear = state.rules.fourOfAKindClears && count === 4;

      if (!isTwoClear && !isFourClear) {
        if (rank <= topRank) return {ok:false, reason:`Must beat ${rankToLabel(topRank)}.`};
      }
    }
    return {ok:true, reason:"OK"};
  }

  function clearPile(message){
    if (message) addLog(message, true);
    state.pileTop=null;
    state.requiredCount=null;
    state.passes.clear();
    state.lastNonPassIndex=null;
  }

  function showOverlay(title, big, muted){
    ovTitle.textContent = title;
    ovBig.textContent = big;
    ovMuted.textContent = muted || "";
    overlay.classList.add("active");
  }
  function hideOverlay(){
    overlay.classList.remove("active");
  }

  function applyPlay(cards){
    const pi = state.turnIndex;
    const player = state.players[pi];

    const set = new Set(cards.map(cardToKey));
    player.hand = player.hand.filter(c => !set.has(cardToKey(c)));

    state.pileTop = { rank: cards[0].rank, count: cards.length, playerIndex: pi };
    state.requiredCount = state.rules.mustMatchSetSize ? cards.length : null;
    state.lastNonPassIndex = pi;
    state.passes.clear();

    addLog(`${player.name} played <b>${rankToLabel(state.pileTop.rank)} √ó ${state.pileTop.count}</b>.`);

    if (player.hand.length === 0 && !player.out){
      player.out=true;
      player.finishIndex=state.finishOrder.length;
      state.finishOrder.push(pi);
      addLog(`${player.name} is OUT!`, true);
    }

    const isTwoClear = state.rules.twoClearsPile && cards[0].rank === 15;
    const isFourClear = state.rules.fourOfAKindClears && cards.length === 4;

    if (isTwoClear || isFourClear){
      clearPile(`${player.name} cleared the pile!`);
      state.handRevealed=false;
      state.selected.clear();
      showOverlay("Pile cleared!", `Pass device to ${player.name}`, "They play again.");
      return;
    }

    state.turnIndex = nextActiveIndex(state.turnIndex);
    state.handRevealed=false;
    state.selected.clear();
    showOverlay("Next player", `Pass device to ${state.players[state.turnIndex].name}`, "Tap Continue when ready.");
  }

  function applyPass(){
    const pi = state.turnIndex;
    const player = state.players[pi];

    addLog(`${player.name} passed.`);
    state.passes.add(pi);

    if (state.pileTop && countActiveNotPassed() <= 1){
      const winner = state.lastNonPassIndex;
      const winnerName = (winner !== null) ? state.players[winner].name : "‚Äî";
      clearPile(`${winnerName} wins the trick and leads.`);
      if (winner !== null) state.turnIndex = winner;

      state.handRevealed=false;
      state.selected.clear();
      showOverlay("Trick won!", `Pass device to ${state.players[state.turnIndex].name}`, "They lead next.");
      return;
    }

    state.turnIndex = nextActiveIndex(state.turnIndex);
    state.handRevealed=false;
    state.selected.clear();
    showOverlay("Next player", `Pass device to ${state.players[state.turnIndex].name}`, "Tap Continue when ready.");
  }

  function isRoundOver(){
    return activePlayerIndices().length <= 1;
  }

  function finishLabel(pos, n){
    if (pos === 0) return "President";
    if (pos === 1) return "Vice President";
    if (pos === n-2) return "Vice Scum";
    if (pos === n-1) return "Scum";
    return `Middle (${pos+1})`;
  }

  function performSwap(aIndex, bIndex, count){
    const A = state.players[aIndex];
    const B = state.players[bIndex];
    if (!A || !B) return;

    sortHand(A.hand); sortHand(B.hand);

    const giveA = A.hand.slice(0, count);
    const giveB = B.hand.slice(Math.max(0, B.hand.length - count));

    const setA = new Set(giveA.map(cardToKey));
    const setB = new Set(giveB.map(cardToKey));
    A.hand = A.hand.filter(c => !setA.has(cardToKey(c)));
    B.hand = B.hand.filter(c => !setB.has(cardToKey(c)));

    A.hand.push(...giveB);
    B.hand.push(...giveA);

    sortHand(A.hand); sortHand(B.hand);
    addLog(`${A.name} swapped ${count} card(s) with ${B.name}.`);
  }

  function finalizeRound(){
    const remaining = activePlayerIndices();
    if (remaining.length === 1){
      const last = remaining[0];
      if (!state.players[last].out){
        state.players[last].out = true;
        state.players[last].finishIndex = state.finishOrder.length;
        state.finishOrder.push(last);
      }
    }

    state.phase = "between_rounds";

    const n = state.players.length;
    addLog(`Round ${state.roundNumber} results:`, true);
    for (let i=0;i<state.finishOrder.length;i++){
      const pi = state.finishOrder[i];
      addLog(`${i+1}. ${state.players[pi].name} ‚Äî <b>${finishLabel(i, n)}</b>`);
    }

    if (state.rules.swapsEnabled && n >= 4){
      const pres = state.finishOrder[0];
      const scum = state.finishOrder[n-1];
      const vp = state.finishOrder[1];
      const vsc = state.finishOrder[n-2];
      performSwap(pres, scum, 2);
      performSwap(vp, vsc, 1);
      addLog(`Swaps applied for next round.`, true);
    }

    clearPile(null);
    btnNextRound.disabled = false;

    showOverlay(
      `Round ${state.roundNumber} complete!`,
      `${state.players[state.finishOrder[0]].name} is President üèÜ`,
      `Tap Continue then Next Round when ready.`
    );
  }

  function startRound(){
    state.phase="in_round";
    state.pileTop=null;
    state.requiredCount=null;
    state.passes.clear();
    state.lastNonPassIndex=null;
    state.finishOrder=[];
    state.selected.clear();
    state.handRevealed=false;

    for (const p of state.players){
      p.out=false; p.finishIndex=null;
      sortHand(p.hand);
    }

    if (state.rules.lowestCardStarts){
      state.turnIndex = findLowestCardHolder();
      state.leaderIndex = state.turnIndex;
      addLog(`Lowest card starts: <b>${state.players[state.turnIndex].name}</b> leads Round ${state.roundNumber}.`, true);
    } else {
      state.turnIndex = state.leaderIndex || 0;
      addLog(`<b>${state.players[state.turnIndex].name}</b> leads Round ${state.roundNumber}.`, true);
    }

    btnNextRound.disabled = true;
    showOverlay("Round start!", `Pass device to ${state.players[state.turnIndex].name}`, "Tap Continue.");
  }

  function startGameFromRules(){
    syncRulesFromUI();
    const n = clampInt(playerCount.value, 3, 8);

    const names=[];
    for (let i=0;i<n;i++){
      const val = ($("pname_"+i)?.value || defaultName(i)).trim();
      names.push(val || defaultName(i));
    }

    state.players = names.map(name => ({ name, hand: [], out:false, finishIndex:null }));
    state.roundNumber = 1;
    state.leaderIndex = 0;

    const deck = makeDeck();
    const hands = deal(deck, n);
    for (let i=0;i<n;i++) state.players[i].hand = hands[i];

    addLog(`Game started with ${n} players.`, true);

    setScreen("game");
    startRound();
    renderAll();
  }

  function nextRound(){
    state.roundNumber++;
    const pres = state.finishOrder[0];
    state.leaderIndex = (pres !== undefined) ? pres : 0;
    startRound();
    renderAll();
  }

  // -------------------- Rendering --------------------
  function renderPile(){
    pileTopEl.textContent = state.pileTop ? `Pile: ${rankToLabel(state.pileTop.rank)} √ó ${state.pileTop.count}` : "Pile: (empty)";
    pileReqEl.textContent = `Required set size: ${state.requiredCount === null ? "‚Äî" : state.requiredCount}`;
    pilePassEl.textContent = `Passes: ${state.passes.size ? [...state.passes].map(i => state.players[i].name).join(", ") : "‚Äî"}`;
  }

  function renderPlayers(){
    playersPanel.innerHTML = "";
    for (let i=0;i<state.players.length;i++){
      const p = state.players[i];
      const div = document.createElement("div");
      div.className = "playerChip" + (state.phase==="in_round" && i===state.turnIndex ? " active" : "");
      const left = document.createElement("div");
      const nm = document.createElement("div");
      nm.className = "name";
      nm.textContent = p.name;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `Cards: ${p.hand.length}` + (p.finishIndex !== null ? ` ‚Ä¢ ${finishLabel(p.finishIndex, state.players.length)}` : "");
      left.appendChild(nm); left.appendChild(meta);

      const right = document.createElement("div");
      right.innerHTML = `<span class="pill"><b>${p.out ? "Out" : (i===state.turnIndex && state.phase==="in_round" ? "Turn" : "Playing")}</b></span>`;

      div.appendChild(left);
      div.appendChild(right);
      playersPanel.appendChild(div);
    }
  }

  function renderHand(){
    handEl.innerHTML = "";
    state.selected.clear();
    selInfo.textContent = "0";

    const p = state.players[state.turnIndex];
    currentName.textContent = p ? p.name : "‚Äî";

    if (state.phase !== "in_round"){
      turnHint.textContent = "Round finished. Tap Next Round.";
      return;
    }

    if (!state.handRevealed){
      turnHint.innerHTML = `<b>${p.name}</b>, tap Reveal to see your cards.`;
      handEl.innerHTML = "";
      btnPlay.disabled = true;
      btnPass.disabled = true;
      btnClearSel.disabled = true;
      return;
    }

    turnHint.innerHTML = `<b>${p.name}</b>, choose matching cards then tap Play (or Pass).`;

    sortHand(p.hand);

    p.hand.forEach((c, idx) => {
      const btn = document.createElement("div");
      btn.className = "cardBtn " + SUIT_COLOR_CLASS[c.suit];
      btn.innerHTML = `<div class="r">${rankToLabel(c.rank)}</div><div class="s">${SUIT_SYMBOL[c.suit]}</div>`;

      btn.addEventListener("click", () => {
        if (!state.handRevealed) return;
        if (state.selected.has(idx)) state.selected.delete(idx);
        else state.selected.add(idx);
        updateSelectionUI();
        renderSelectionOnly();
      });

      handEl.appendChild(btn);
    });

    renderSelectionOnly();
    updateSelectionUI();
  }

  function renderSelectionOnly(){
    const children = [...handEl.children];
    children.forEach((node, idx) => {
      if (!(node instanceof HTMLElement)) return;
      node.classList.toggle("sel", state.selected.has(idx));
    });
  }

  function updateSelectionUI(){
    const p = state.players[state.turnIndex];
    const idxs = [...state.selected].sort((a,b)=>a-b);
    const cards = idxs.map(i => p.hand[i]).filter(Boolean);
    selInfo.textContent = String(cards.length);

    btnClearSel.disabled = cards.length === 0;
    const inTurn = state.phase==="in_round" && state.handRevealed && !p.out;
    btnPass.disabled = !inTurn;
    btnPlay.disabled = !(inTurn && cards.length>0);
  }

  function renderRoundPill(){
    roundPill.textContent = state.screen === "game" ? String(state.roundNumber) : "‚Äî";
  }

  function renderAll(){
    renderRoundPill();
    renderPile();
    renderPlayers();
    renderHand();
  }

  // -------------------- Events --------------------
  btnGoPlay.addEventListener("click", () => setScreen("rules"));
  btnGoRules.addEventListener("click", () => setScreen("rules"));
  btnBackHome1.addEventListener("click", () => setScreen("home"));

  playerCount.addEventListener("change", renderPlayerInputs);
  preset.addEventListener("change", () => applyPreset(preset.value));

  [r_twoClears, r_fourClears, r_matchSize, r_lowestStarts, r_swaps].forEach(el => {
    el.addEventListener("change", () => { syncRulesFromUI(); });
  });

  btnStartGame.addEventListener("click", () => {
    startGameFromRules();
  });

  btnExitToHome.addEventListener("click", () => {
    // safe exit
    setScreen("home");
  });

  btnReveal.addEventListener("click", () => {
    if (state.phase !== "in_round") return;
    state.handRevealed = true;
    renderAll();
  });

  btnHide.addEventListener("click", () => {
    state.handRevealed = false;
    state.selected.clear();
    renderAll();
  });

  btnClearSel.addEventListener("click", () => {
    state.selected.clear();
    updateSelectionUI();
    renderSelectionOnly();
  });

  btnPlay.addEventListener("click", () => {
    if (state.phase !== "in_round") return;
    if (!state.handRevealed) return;

    const p = state.players[state.turnIndex];
    const idxs = [...state.selected].sort((a,b)=>a-b);
    const cards = idxs.map(i => p.hand[i]).filter(Boolean);

    const v = validateSelection(cards);
    if (!v.ok){
      alert(v.reason);
      return;
    }

    applyPlay(cards);
    if (isRoundOver()) finalizeRound();
    renderAll();
  });

  btnPass.addEventListener("click", () => {
    if (state.phase !== "in_round") return;
    if (!state.handRevealed) {
      alert("Tap Reveal first.");
      return;
    }
    applyPass();
    if (isRoundOver()) finalizeRound();
    renderAll();
  });

  btnNextRound.addEventListener("click", () => {
    if (state.phase !== "between_rounds") return;
    nextRound();
  });

  ovOk.addEventListener("click", () => {
    hideOverlay();
    renderAll();
  });

  // -------------------- Boot --------------------
  renderPlayerInputs();
  applyPreset("classic");
  syncRulesFromUI();
  setScreen("home");
  renderAll();
})();
</script>
</body>
</html>
